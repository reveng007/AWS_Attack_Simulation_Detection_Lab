# 14.SOCLabs: AWS EC2 Security Group Public Exposure of SSH Port 22

https://www.soc-labs.top/en/detections/94

## Goal: 
Write a detection rule to identify instances where the `AuthorizeSecurityGroupIngress` CloudTrail event is used to allow access to security group port `22` from unknown external IPs or from `0.0.0.0/0`.

## Detailed Reasoning :

https://stratus-red-team.cloud/attack-techniques/AWS/aws.exfiltration.ec2-security-group-open-port-22-ingress/

You can use the CloudTrail event AuthorizeSecurityGroupIngress when:

- `requestParameters.cidrIp` is `0.0.0.0/0` (or an unknown external IP)
- and `requestParameters.fromPort/requestParameters.toPort` is not a commonly exposed port or corresponds to a known administrative protocol such as SSH or RDP

## Sigma Query:
```yaml
title: AWS Security Group Public Exposure of SSH Port 22
status: test
description: AWS Security Group Public Exposure of SSH Port 22
references:
    - https://stratus-red-team.cloud/attack-techniques/AWS/aws.exfiltration.ec2-security-group-open-port-22-ingress/
author: Soumyanil Biswas
date: 2025-10-18
modified: 2025-10-18
tags:
    - attack.xxxx
logsource:
    product: aws
    service: cloudtrail
detection:
    selection:
        eventSource: ec2.amazonaws.com
        eventType: AwsApiCall
        
        eventName: AuthorizeSecurityGroupIngress

        requestParameters.cidrIp: 0.0.0.0/0
        requestParameters.fromPort: 22
        requestParameters.toPort: 22

    condition: selection 
falsepositives:
    - unknown
level: high
fields:
    - eventName
    - sourceIPAddress
    - eventID
    - eventSource
    - userIdentity.arn
    - userIdentity.arn
```

## Query Result:

<img width="1806" height="263" alt="image" src="https://github.com/user-attachments/assets/7ba41900-98cd-402f-b500-4e9ccfc97405" />
